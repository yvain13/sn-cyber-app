import React, { useMemo } from 'react';

export default function VulnerabilityHeatmap({ vulnerabilities, onVulnerabilityClick }) {
  const heatmapData = useMemo(() => {
    const severities = ['Low', 'Medium', 'High', 'Critical'];
    const statuses = ['Open', 'In Progress', 'Resolved'];
    
    const matrix = {};
    severities.forEach(severity => {
      matrix[severity] = {};
      statuses.forEach(status => {
        matrix[severity][status] = [];
      });
    });

    vulnerabilities.forEach(vuln => {
      const severity = typeof vuln.severity === 'object' ? 
        vuln.severity.display_value : vuln.severity;
      const status = typeof vuln.status === 'object' ? 
        vuln.status.display_value : vuln.status;
        
      if (matrix[severity] && matrix[severity][status] !== undefined) {
        matrix[severity][status].push(vuln);
      }
    });

    return { matrix, severities, statuses };
  }, [vulnerabilities]);

  const getIntensityColor = (count, maxCount) => {
    if (count === 0) return '#f8f9fa';
    const intensity = count / Math.max(maxCount, 1);
    const alpha = Math.min(0.2 + intensity * 0.8, 1);
    return `rgba(52, 152, 219, ${alpha})`;
  };

  const maxCount = useMemo(() => {
    let max = 0;
    Object.values(heatmapData.matrix).forEach(severityRow => {
      Object.values(severityRow).forEach(statusCell => {
        max = Math.max(max, statusCell.length);
      });
    });
    return max;
  }, [heatmapData.matrix]);

  const handleCellClick = (vulnerabilities) => {
    if (vulnerabilities.length > 0 && onVulnerabilityClick) {
      // For demo purposes, click the first vulnerability
      onVulnerabilityClick(vulnerabilities[0]);
    }
  };

  return (
    <div className="widget-card">
      <h2 className="widget-title">Vulnerability Heatmap</h2>
      <div className="heatmap-container" style={{ padding: '20px 0' }}>
        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
          <thead>
            <tr>
              <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>
                Severity \ Status
              </th>
              {heatmapData.statuses.map(status => (
                <th 
                  key={status} 
                  style={{ 
                    padding: '12px', 
                    textAlign: 'center', 
                    borderBottom: '2px solid #dee2e6',
                    fontWeight: '600',
                    color: '#2c3e50'
                  }}
                >
                  {status}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {heatmapData.severities.map(severity => (
              <tr key={severity}>
                <td style={{ 
                  padding: '12px', 
                  fontWeight: '600',
                  color: '#2c3e50',
                  borderRight: '2px solid #dee2e6'
                }}>
                  {severity}
                </td>
                {heatmapData.statuses.map(status => {
                  const vulnerabilities = heatmapData.matrix[severity][status];
                  const count = vulnerabilities.length;
                  return (
                    <td 
                      key={`${severity}-${status}`}
                      onClick={() => handleCellClick(vulnerabilities)}
                      style={{ 
                        padding: '12px',
                        textAlign: 'center',
                        backgroundColor: getIntensityColor(count, maxCount),
                        border: '1px solid #dee2e6',
                        cursor: count > 0 ? 'pointer' : 'default',
                        fontWeight: '600',
                        color: count > maxCount * 0.5 ? 'white' : '#2c3e50',
                        transition: 'all 0.3s ease',
                        position: 'relative'
                      }}
                      onMouseEnter={(e) => {
                        if (count > 0) {
                          e.target.style.transform = 'scale(1.05)';
                          e.target.style.zIndex = '10';
                          e.target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                        }
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.transform = 'scale(1)';
                        e.target.style.zIndex = '1';
                        e.target.style.boxShadow = 'none';
                      }}
                      title={count > 0 ? `${count} vulnerabilities - Click to view details` : ''}
                    >
                      {count}
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}